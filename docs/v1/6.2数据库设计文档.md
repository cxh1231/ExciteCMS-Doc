## 1、需求分析

[上一节](/docs/v1/6.1需求分析文档.md)，我们确定了本 `ExciteCMS` 基于 `RBAC策略` 实现系统的权限管理，并且选定了前端模板。

对于后台管理系统，首先需要有系统`用户`，即`User实体`。

不同的用户需要具有不同的`权限`，即`Permission实体`。

在以往的系统中，这两个实体是一对多的关系，即直接为用户分配各个的权限，但这不符合**RBAC模型**。

当前的系统通常在`用户`和`权限`之间增加一个过渡的**角色**，即`Role实体`。

当增加角色实体后，这三者之间的关系变成：**用户→角色→权限**，即为用户分配指定的某个或某些角色，然后为角色分配某些权限。

这时，用户和角色实体之间是`一对多`的关系，角色和权限之间是`一对多`的关系。

我们继续对**RBAC**及**页面**进行分析，不同用户登录系统后，因为其具有的权限不同，故其所显示的菜单、按钮等，均应不同，需要根据权限来动态调整、显示。

所以，还需要为系统增加一个菜单的控制，即`Menu实体`。

不过，**菜单**需要单独分配一个新的实体吗？或者说**权限**和**菜单**，是否可以进行合并？

通过分析不同的系统，都有自己的实现方案，有的系统将**菜单**和**权限**分成两个实体，有的系统将其**合并**为一个实体。

再仔细分析一下，**权限**最终体现出来的是一个**路由**地址，比如`/user/get`，而**菜单**，用户访问的也是一个**路由**地址，比如`/user/center`。

所以，本系统采用后一种方案：将**权限（Permission）**实体和**菜单（Menu）**实体合并为一个实体——**菜单（Menu）实体**。

> 为什么不合并成**权限（Permission）实体**？这是完全OK的。但是**Permission**比如**Menu**字母少，所以我们选择**Menu** \^_\^

最终，本 `ExciteCMS` 实现权限管理，需要的几个实体如下所示：

+ 用户 --- User
+ 角色 --- Role
+ 菜单（权限） --- Menu

> 后文中提到`菜单`和`权限`是相同的含义，即都属于**菜单实体**（或称之为**菜单表**）

## 2、数据库设计

前面分析了本系统有三个主要的实体：用户、角色和菜单，故每个基本的实体，应该具有一个数据库表单：

+ 用户表
+ 角色表
+ 菜单表

分析了用户和角色、角色和菜单之间是有联系的，即存在一对多的关系，则应该为其增加两个关联表：

+ 用户—角色 关联表
+ 角色—菜单 关联表

接下来分析每个基本表，应该具有的属性及类型。

### 2.1 用户表

**用户表**首先需要有固定不变的**主键**，来保证每个用户的唯一。

用户登录需要登录名和**密码**，这里我们使用**邮箱**和**手机号**作为用户的登录名。

此外，用户还可能具有昵称、头像、用户状态（封禁与否）、最后登录IP、最后登录时间等等属性。

最终，保证用户属性的最大化，我们设计的用户表属性及其类型，如下表所示。

| 属性列名    | 属性说明     | 数据类型    | 备注                   |
| ----------- | ------------ | ----------- | ---------------------- |
| **id**      | **用户主键** | int (11)    | 自增（起始值10000）    |
| nickname    | 用户昵称     | char (63)   |                        |
| avatar      | 用户头像     | char (255)  | URL                    |
| sex         | 用户性别     | tinyint (2) | 0-未知 \| 1-男 \| 2-女 |
| email       | 用户邮箱     | char (127)  |                        |
| phone       | 用户手机号   | char (31)   |                        |
| password    | 用户密码     | char (127)  |                        |
| status      | 用户状态     | tinyint (2) | 0-正常 \| 1-封禁       |
| login_ip    | 登录IP       | char (64)   |                        |
| login_date  | 登录时间     | datetime    |                        |
| is_delete   | 是否删除     | tinyint (2) | 0-未删除 \| 1-已删除   |
| create_time | 创建时间     | datetime    |                        |
| update_time | 更新时间     | datetime    |                        |
| delete_time | 删除时间     | datetime    |                        |

对于`status`字段，是该用户的**状态字段**，即用户是否被封禁（限制登录）。

> 这里对于所有的`标记类`字段进行统一说明：
>
>   + `0`均表示`正常`，`1`均表示`异常`！
>   + 均定义为`tinyint(2)`。
>
>   为什么字段长度为2，不是1？
>
>   + 因为有时候长度定义为1后，有的**代码生成器**将该字段判断为**Boolean**类型。如果后期再增加其他标记（如`2-禁止操作`），将无法增加新标记。

对于`is_delete`字段，是开启**逻辑删除**是，用到的字段。

**逻辑删除**是一个很重要的概念，与之相对的是**物理删除**。

逻辑删除是通过一个字段的取值，作为删除与否的标记；而物理删除，则是将记录从数据表中直接删除。

当然也有插件使用`delete_time`字段作为删除与否，即字段不为空表示已删除。这里表设计，将这两个字段都保留。

> 规定：本系统所有的基础数据表，均应包含后四行！关联表等，可以不包含。

### 2.2 角色表

**角色表**的属性就比较简单了，主要是**角色主键**和**角色名称**。

我们设计的角色表如下所示。

| 属性列名    | 属性说明       | 数据类型    | 备注                 |
| ----------- | -------------- | ----------- | -------------------- |
| id          | 角色主键       | int (11)    | 自增（起始值100）    |
| name        | 角色名称       | char (63)   |                      |
| permission  | 角色权限标识符 | char (63)   | 示例：admin、guest   |
| remark      | 备注说明       | char (255)  |                      |
| sort        | 排序           | int (11)    | 数值越大越靠前       |
| status      | 角色状态       | tinyint (2) | 0-正常 \| 1-封禁     |
| is_delete   | 是否删除       | tinyint (2) | 0-未删除 \| 1-已删除 |
| create_time | 创建时间       | datetime    |                      |
| update_time | 更新时间       | datetime    |                      |
| delete_time | 删除时间       | datetime    |                      |

对于`permission`字段，是角色的标记，作为`路由鉴权`或者`注解鉴权`的标记，详细使用方法在项目开发中说明。

对于`sort`字段，是角色的显示排序，数值越大越靠前。

### 2.3 菜单（权限）表

通过对前端显示的分析，发现一个菜单必须具有**菜单名**、**图标**、**上级菜单**、**路由地址**等属性。

所以本系统的**菜单表**设计如下。

| 属性列名    | 属性说明      | 数据类型    | 备注                                             |
| ----------- | ------------- | ----------- | ------------------------------------------------ |
| id          | 菜单/权限主键 | int (11)    | 自增（起始值0）                                  |
| name        | 菜单/权限名称 | char (63)   |                                                  |
| icon        | 菜单图标      | char (63)   |                                                  |
| path        | 菜单/权限路由 | char (63)   | 对于后台`控制类`定义，示例：system/user/get/{id} |
| permission  | 权限标识符    | char (63)   | 对于后台`控制类`定义，示例：system:user:list     |
| component   | 组件路径      | char (63)   | 对于`前端框架`定义，示例：system/user/index      |
| parent_id   | 上级菜单ID    | int (11)    |                                                  |
| type        | 菜单类型      | char (2)    | C - 目录 \| M - 菜单 \| B - 按钮                 |
| sort        | 排序          | int (11)    | 数值越大越靠前                                   |
| editable    | 可编辑        | tinyint (2) | 0-禁止编辑 \| 1-可编辑                           |
| removable   | 可删除        | tinyint (2) | 0-禁止删除 \| 1-可删除                           |
| status      | 状态          | tinyint (2) | 0-正常 \| 1-封禁                                 |
| is_delete   | 是否删除      | tinyint (2) | 0-未删除 \| 1-已删除                             |
| create_time | 创建时间      | datetime    |                                                  |
| update_time | 更新时间      | datetime    |                                                  |
| delete_time | 删除时间      | datetime    |                                                  |

对于`parent_id`，本表已经设置为从0开始自增。如果是`顶级菜单`（即顶部导航栏菜单），则其上级ID为 `-1`。

### 2.4 用户—角色 关联表

关联表的设计最简单，需要将关联的两个表的ID放进来即可。

| 属性列名    | 属性说明   | 数据类型    | 备注                 |
| ----------- | ---------- | ----------- | -------------------- |
| id          | 关联表的ID | int (11)    | 自增（起始值0）      |
| user_id     | 用户ID     | int (11)    |                      |
| role_id     | 角色ID     | int (11)    |                      |
| is_delete   | 是否删除   | tinyint (2) | 0-未删除 \| 1-已删除 |
| create_time | 创建时间   | datetime    |                      |
| update_time | 更新时间   | datetime    |                      |
| delete_time | 删除时间   | datetime    |                      |

> 对于关联表，后四行属性可以删除，默认使用物理删除。
>
>   **正式项目开发中的数据库未包含后四行。**

### 2.5 角色—菜单（权限） 关联表

不多赘述，直接开始。

| 属性列名    | 属性说明    | 数据类型    | 备注                 |
| ----------- | ----------- | ----------- | -------------------- |
| id          | 关联表的ID  | int (11)    | 自增（起始值0）      |
| role_id     | 角色ID      | int (11)    |                      |
| menu_id     | 菜单/权限ID | int (11)    |                      |
| is_delete   | 是否删除    | tinyint (2) | 0-未删除 \| 1-已删除 |
| create_time | 创建时间    | datetime    |                      |
| update_time | 更新时间    | datetime    |                      |
| delete_time | 删除时间    | datetime    |                      |

> 此关联表同上。

以上就是对五个基础表单的设计。

这五个表单的关系如下图所示。

![image-20210918195131759](https://img.zxdmy.com/2021/20210918195138.png)

## 3、数据库实施

接下来，我们在`Navicat`中，链接至本地数据库服务器，并**创建新的数据库**，三项参数如下：

+ 数据库名：db_excite
+ 字符集：utf8
+ 排序规则：utf8_general_ci

如下图所示。

![image-20210824214040084](https://img.zxdmy.com/2021/20210824220421.png)

然后确定，即可创建完毕。

然后我们继续**创建数据库表**，这里直接根据**数据库设计**部分的表单进行填充即可。

填写完毕，先`Ctrl+S`保存一下，填写表名为：`sys_user`。如下图所示。

![image-20210824215845003](https://img.zxdmy.com/2021/20210824220426.png)

> 这里规定：所有的系统表单，前缀均为`sys_`。

然后切换至`选项`页，设置主键的自增起始值为`10000`。

![image-20210824215453231](https://img.zxdmy.com/2021/20210824220430.png)

然后继续`保存`即可。

其他几个表单的添加方式类似。

附件是完成添加后的数据库SQL脚本，可以直接下载，导入数据库。

> 建议添加一部分测试数据，方便后端开发时，直接测试使用。附件SQL脚本含有测试数据。

至此，本`ExciteCMS`的数据库分析与设计完毕。
